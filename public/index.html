<script>
  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const socket = new WebSocket(`${protocol}://${location.host}`);

  socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const currentTime = new Date().toLocaleString();

    const slackStatusElement = document.getElementById('slackStatus');
    slackStatusElement.className = 'status-circle ' + (data.slack.service_status === 'Disponible' ? 'status-ok' : 'status-error');

    const anydeskStatusElement = document.getElementById('anydeskStatus');
    anydeskStatusElement.className = 'status-circle ' + (data.anydesk.service_status === 'Disponible' ? 'status-ok' : 'status-error');

    const pingStatusElement = document.getElementById('pingStatus');
    pingStatusElement.innerHTML = '';

    Object.keys(data.ping).forEach(ip => {
      const pingResult = data.ping[ip];
      const city = pingResult.city;
      const statusClass = pingResult.status === 'Disponible'
        ? 'status-ok'
        : (pingResult.status === 'Incident détecté' ? 'status-warning' : 'status-error');

      const pingItem = document.createElement('div');
      pingItem.className = 'item-row';
      pingItem.innerHTML = `<div class="item-name">${city}</div><div class="status-circle ${statusClass}"></div>`;
      pingStatusElement.appendChild(pingItem);
    });

    const lastUpdatedElement = document.getElementById('lastUpdated');
    lastUpdatedElement.textContent = `Dernière mise à jour : ${currentTime}`;
  };

  socket.onopen = () => {
    console.log('✅ Connexion WebSocket établie');
  };

  socket.onclose = () => {
    console.log('❌ Connexion WebSocket fermée');
  };
</script>
